{% extends 'OroUIBundle:actions:view.html.twig' %}
{% import 'OroUIBundle::macros.html.twig' as macros %}

{% oro_title_set({params : {"%workflow_definition.label%": entity.label} }) %}

{% block navButtons %}
    {% if resource_granted('EDIT', entity) and not entity.system %}
        {{ UI.editButton({
            'path' : path('oro_workflow_definition_update', { 'name': entity.name }),
            'entity_label': 'oro.workflow.workflowdefinition.entity_label'|trans
        }) }}
    {% endif %}
    {% if resource_granted('DELETE', entity) %}
        {{ UI.deleteButton({
            'dataUrl': path('oro_api_workflow_definition_delete', {'workflowDefinition': entity.name}),
            'dataRedirect': path('oro_workflow_definition_index'),
            'aCss': 'no-hash remove-button',
            'id': 'btn-remove-workflow-definition',
            'dataId': entity.name,
            'entity_label': 'oro.workflow.workflowdefinition.entity_label'|trans
        }) }}
    {% endif %}
{% endblock navButtons %}

{% block stats %}
    <li>{{ 'oro.workflow.workflowdefinition.created_at.label'|trans }}: {{ entity.createdAt ? entity.createdAt|oro_format_datetime : 'N/A' }}</li>
    <li>{{ 'oro.workflow.workflowdefinition.updated_at.label'|trans }}: {{ entity.updatedAt ? entity.updatedAt|oro_format_datetime : 'N/A' }}</li>
{% endblock stats %}

{% block pageHeader %}
    {% set breadcrumbs = {
        'entity': entity,
        'indexPath': path('oro_workflow_definition_index'),
        'indexLabel': 'oro.workflow.workflowdefinition.entity_plural_label'|trans,
        'entityTitle': entity.label
    } %}
    {{ parent() }}
{% endblock pageHeader %}

{% block breadcrumbs %}
    {{ parent() }}

    {% set entityConfiguration = oro_entity_config(entity.relatedEntity, 'workflow') %}
    {% set isActive = entityConfiguration.active_workflow is defined and entityConfiguration.active_workflow == entity.name %}

    <div class="status-enabled pull-left">
        {% if isActive %}
            <div class="badge badge-enabled status-enabled"><i class="icon-status-enabled icon-circle"></i>{{ 'Active'|trans }}</div>
        {% else %}
            <div class="badge badge-enabled status-disabled"><i class="icon-status-disabled icon-circle"></i>{{ 'Inactive'|trans }}</div>
        {% endif %}
    </div>
{% endblock breadcrumbs %}

{% block content_data %}
    {% set workflowDefinitionInfo %}
        {{ oro_widget_render({
            'widgetType': 'block',
            'url': path('oro_workflow_definition_view', {name: entity.name}),
        }) }}
    {% endset %}

    {% set workflowStepsAndTransitions %}
        <style type="text/css">
            .transitions-list-short {
                margin-left: 0;
            }

            .transitions-list-short li {
                list-style: none;
            }
        </style>
        <div class="workflow-definition-steps-list-container">
            <div class="grid-container steps-list">
                <table class="grid table-hover table table-bordered table-condensed" style="margin-bottom: 10px">
                    <thead>
                        <th class="label-column"><span>{{ "Step"|trans }}</span></th>
                        <th><span>{{ "Transitions"|trans }}</span></th>
                        <th>
                            <span title="{{ "oro.workflow.workflowdefinition.step.order.tooltip"|trans({}, "tooltips") }}">
                                {{ "Position"|trans }}
                            </span>
                        </th>
                    </thead>
                    <tbody class="item-container">
                        {% set startStep = [{
                            'label': '(' ~ 'Start'|trans ~ ')',
                            'order': -1,
                            'is_final': false,
                            'allowed_transitions': startTransitionNames
                        }] %}

                        {% if entity.configuration.steps is defined %}
                            {% set steps = startStep|merge(entity.configuration.steps) %}
                        {% else %}
                            {% set steps = [startStep] %}
                        {% endif %}

                        {% for stepData in steps %}
                            <tr>
                                <td class="step-name">
                                    {{ stepData.label }}
                                    {% if stepData.is_final %}
                                        &nbsp;
                                        <strong title="{{ "oro.workflow.workflowdefinition.step.is_final.tooltip"|trans({}, "tooltips") }}">
                                            ({{ "Final"|trans }})
                                        </strong>
                                    {% endif %}
                                </td>
                                <td class="step-transitions">
                                    {% if stepData.allowed_transitions is not empty %}
                                        <ul class="transitions-list-short">
                                            {% for key, transitionName in stepData.allowed_transitions %}
                                                {% set currentTransition = entity.configuration.transitions[transitionName] %}
                                                {% set toStep = entity.configuration.steps[currentTransition.step_to] %}
                                                <li>
                                                    <span>{{ currentTransition.label }}</span>
                                                    <i class="icon-long-arrow-right"></i>
                                                    <span title="{{ "oro.workflow.workflowdefinition.transition.step_to.tooltip"|trans({}, "tooltips") }}">
                                                        {{ toStep.label }}
                                                    </span>
                                                </li>
                                            {% endfor %}
                                        </ul>
                                    {% endif %}
                                </td>
                                <td>
                                    <span title="{{ "oro.workflow.workflowdefinition.step.order.tooltip"|trans({}, "tooltips") }}">
                                        {{ stepData.order }}
                                    </span>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    {% endset %}

    {% set dataBlocks = [
        {
            'title': 'General Information'|trans,
            'class': 'active',
            'subblocks': [
                {'data' : [workflowDefinitionInfo] },
            ]
        },
        {
            'title': 'Configuration'|trans,
            'subblocks': [
                {
                    'title': 'Workflow steps and transitions'|trans,
                    'data':  [workflowStepsAndTransitions]
                },
            ]
        },
    ] %}

    {% set id = 'workflowDefinitionView' %}
    {% set data = {'dataBlocks': dataBlocks} %}
    {{ parent() }}
{% endblock content_data %}
